@page "/BoardGamePage/{id}"
@using LendStuff.Shared
@using LendStuff.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider

@attribute [Authorize]

@inject HttpClient HttpClient
<h3>BoardGamePage</h3>

@if (@CurrentBoardGameDto == null)
{
	<p>Loading....</p>
}
else
{
	@CurrentBoardGameDto.Title

	//Lista användare som har spelet. Borde göra som en table för att kunna sortera efter stad etc.
	//Vill inte lista sina egna spel heller:
	<Virtualize Items="UserOwningBoardGame.ToList()" Context="userDto">
		<li class="list-group-item list-group-item-action">
			<div class="container row">
				<div class="container col-2">
					<p>Username: @userDto.UserName</p>
				</div>
				<div class="container col-2">
					<AuthorizeView>
						<div class="form-check">
							<button class="btn-primary" @onclick="() => SendMessage(userDto)">Send request</button>
						</div>
					</AuthorizeView>
				</div>
			</div>
		</li>
	</Virtualize>

	<p>@ResponseMessage</p>	

}
@code {
	[Parameter]
	public string Id { get; set; }

	public BoardGameDto CurrentBoardGameDto;
	public IEnumerable<UserDto> UserOwningBoardGame = new List<UserDto>();
	public string ResponseMessage = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		var userInfo = await AuthenticationStateProvider.GetAuthenticationStateAsync();

		var result = await HttpClient.GetFromJsonAsync<ServiceResponse<BoardGameDto>>(HttpClient.BaseAddress + $"getGameById?id={Id}");

		if (result != null)
		{
			CurrentBoardGameDto = result.Data;
		}

		var usersOwningBoardGameResult = await HttpClient.GetFromJsonAsync<ServiceResponse<IEnumerable<UserDto>>>(HttpClient.BaseAddress + $"usersOwningABoardGame?Id={Id}");

		if (usersOwningBoardGameResult!= null && usersOwningBoardGameResult.Success)
		{
			UserOwningBoardGame = usersOwningBoardGameResult.Data.Where(g => g.UserName != userInfo.User.Identity.Name);
		}

		await base.OnInitializedAsync();
	}

	private async Task SendMessage(UserDto userDto)
	{
		var userInfo = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		
		//TODO: Lägg till mer info för användaren i meddelandet. Kanske en länk till användarens sida?

		var newRequstDto = new MessageDto()
		{
			Message = $"{userInfo.User.Identity.Name} wants to borrow {CurrentBoardGameDto.Title} from you. Please send a respons if game is available or not.",
			SentFromUserName = $"{userInfo.User.Identity.Name}",
			SentToUserName = userDto.UserName
		};
		//TODO: Borde komma en fråga om man verkligen vill skicka?

		var response = await HttpClient.PostAsJsonAsync(HttpClient.BaseAddress + "addMessage", newRequstDto);

		var result = await response.Content.ReadFromJsonAsync<ServiceResponse<MessageDto>>();

		ResponseMessage = result.Message;
	}

}